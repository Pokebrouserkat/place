<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Place</title>
    <script>
        const ws = new WebSocket("/ws");
        const tileColors = {};
        var canvasSize = 50;
        var rateLimit = -1;
        var canPlace = false;
        var didGetCanPlace = false;
        
        ws.onmessage = (event) => {
            console.log("Received message:", event.data);
            // Is it a number?
            if (!isNaN(event.data)) {
                if (rateLimit === -1) {
                    rateLimit = parseInt(event.data);
                    console.log("Rate limit set to:", rateLimit);
                    return;
                }
                if (!didGetCanPlace) {
                    didGetCanPlace = true;
                    console.log("Can place set to true");
                    setTimeout(function() {
                        canPlace = true;
                        document.getElementById("colours").classList.remove("hidden");
                        document.getElementsByTagName("audio")[0].play();
                    }, (parseInt(event.data) + 1) * 1000);
                    return;
                }
                canvasSize = parseInt(event.data);
                console.log("Canvas size set to:", canvasSize);
                return;
            }
            const data = JSON.parse(event.data);
            console.log("Parsed data:", data);
            tileColors[`${data.x},${data.y}`] = data.color;
            //drawGrid();
        };
        
        ws.onclose = () => {
            console.log("WebSocket closed, reloading page.");
            location.reload();
        };

        var username = localStorage.getItem("username");
        var password = localStorage.getItem("password");

        if (window.location.hash) {
            console.log("Parsing hash parameters");
            for (const param of window.location.hash.slice(1).split("&")) {
                const [key, value] = param.split("=");
                switch (key) {
                    case "x":
                        offsetX = parseFloat(value);
                        break;
                    case "y":
                        offsetY = parseFloat(value);
                        break;
                    case "zoom":
                        zoom = parseFloat(value);
                        break;
                    case "name":
                        username = value;
                        break;
                    case "pass":
                    case "password":
                    case "pswd":
                        password = value;
                }
            }
        }

        if (!username) {
            username = prompt("Enter your username:");
        }
        if (!password) {
            password = prompt("Enter your password:");
        }
        localStorage.setItem("username", username);
        localStorage.setItem("password", password);

        function sha1(msg) {
            function rotl(n, s) { return n << s | n >>> 32 - s; }
            function tohex(i) { for (var h = "", s = 28; ; s -= 4) { h += (i >>> s & 0xf).toString(16); if (!s) return h; } }
            var H0 = 0x67452301, H1 = 0xEFCDAB89, H2 = 0x98BADCFE, H3 = 0x10325476, H4 = 0xC3D2E1F0;
            var wa = [], i, l, t, W = [];
            msg += String.fromCharCode(0x80);
            while (msg.length % 4) msg += String.fromCharCode(0);
            for (i = 0; i < msg.length; i += 4) wa.push(msg.charCodeAt(i) << 24 | msg.charCodeAt(i + 1) << 16 | msg.charCodeAt(i + 2) << 8 | msg.charCodeAt(i + 3));
            while (wa.length % 16 != 14) wa.push(0);
            wa.push(msg.length >>> 29), wa.push((msg.length << 3) & 0xFFFFFFFF);
            for (i = 0; i < wa.length; i += 16) {
                for (var j = 0; j < 16; j++) W[j] = wa[i + j];
                for (j = 16; j < 80; j++) W[j] = rotl(W[j - 3] ^ W[j - 8] ^ W[j - 14] ^ W[j - 16], 1);
                var a = H0, b = H1, c = H2, d = H3, e = H4;
                for (j = 0; j < 80; j++) {
                    var s = j < 20 ? [1518500249, (b & c) | (~b & d)] : j < 40 ? [1859775393, b ^ c ^ d] : j < 60 ? [-1894007588, (b & c) | (b & d) | (c & d)] : [-899497514, b ^ c ^ d];
                    t = [rotl(a, 5) + e + W[j] + s[0] + s[1] & 0xFFFFFFFF, a, rotl(b, 30), c, d];
                    e = t[0]; a = t[1]; b = t[2]; c = t[3]; d = t[4];
                }
                H0 = H0 + a & 0xFFFFFFFF; H1 = H1 + b & 0xFFFFFFFF; H2 = H2 + c & 0xFFFFFFFF; H3 = H3 + d & 0xFFFFFFFF; H4 = H4 + e & 0xFFFFFFFF;
            }
            return tohex(H0) + tohex(H1) + tohex(H2) + tohex(H3) + tohex(H4);
        }

        const id = sha1(username + password);
        console.log("User ID:", id);
        
        ws.onopen = () => {
            console.log("WebSocket opened, sending ID");
            ws.send(id);
        };

        window.location.hash = "";
        var canvas;
        var chosenColor = null;
        var ctx;
        const tileSize = 20;
        let zoom = 1;
        let offsetX = 0;
        let offsetY = 0;
        let selectedTile = null;
        const keysPressed = {};
        const velocity = { x: 0, y: 0 };
        const maxSpeed = 10;
        const acceleration = 0.4;
        const deceleration = 0.8;

        const resizeCanvas = () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            //drawGrid();
        }

        function drawGrid() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const cols = Math.ceil(canvas.width / (tileSize * zoom)) + 2;
            const rows = Math.ceil(canvas.height / (tileSize * zoom)) + 2;
            const startX = Math.floor(offsetX) - Math.floor(cols / 2);
            const startY = Math.floor(offsetY) - Math.floor(rows / 2);
            ctx.fillStyle = "#000000";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            var tileSizeTimesZoom = tileSize * zoom;
            var tileSizeTimesZoomMinusOne = (tileSize - 1) * zoom;
            var floorColsDiv2 = cols >> 1;
            var floorRowsDiv2 = rows >> 1;
            for (let x = startX; x < startX + cols; x++) {
                for (let y = startY; y < startY + rows; y++) {
                    const color = tileColors[`${x},${y}`] || (((Math.abs(x) < canvasSize) && (Math.abs(y) < canvasSize)) ? "#ffffff" : "#000000");
                    ctx.fillStyle = color;
                    const drawX = (x - offsetX + floorColsDiv2) * tileSizeTimesZoom;
                    const drawY = (y - offsetY + floorRowsDiv2) * tileSizeTimesZoom;
                    ctx.fillRect(drawX, drawY, tileSizeTimesZoomMinusOne, tileSizeTimesZoomMinusOne);
                }
            }
        }

        function handleTileClick(x, y, mouseX, mouseY) {
            console.log("Tile clicked:", { x, y, mouseX, mouseY });
            if (chosenColor) {
                const confirmChange = confirm("Change the tile colour?");
                if (confirmChange) {
                    console.log("Sending tile change:", { x, y, color: chosenColor });
                    ws.send(JSON.stringify({ x: x - 1, y: y - 2, color: chosenColor }));
                    canPlace = false;
                    chosenColor = null;
                    document.getElementById("red").classList.remove("selected");
                    document.getElementById("green").classList.remove("selected");
                    document.getElementById("blue").classList.remove("selected");
                    document.getElementById("yellow").classList.remove("selected");
                    document.getElementById("purple").classList.remove("selected");
                    document.getElementById("cyan").classList.remove("selected");
                    document.getElementById("white").classList.remove("selected");
                    document.getElementById("black").classList.remove("selected");
                }
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            console.log("Document loaded");
            canvas = document.getElementById("canvas");
            ctx = canvas.getContext("2d");
            resizeCanvas();
            window.addEventListener("resize", resizeCanvas);
            canvas.addEventListener("click", (event) => {
                const rect = canvas.getBoundingClientRect();
                const mouseX = event.clientX - rect.left;
                const mouseY = event.clientY - rect.top;
                const tileX = Math.floor((mouseX / (tileSize * zoom)) + offsetX - (canvas.width / (tileSize * zoom) / 2));
                const tileY = Math.floor((mouseY / (tileSize * zoom)) + offsetY - (canvas.height / (tileSize * zoom) / 2));
                console.log("Canvas click:", { mouseX, mouseY, tileX, tileY });
                handleTileClick(tileX, tileY, mouseX, mouseY);
            });
            document.addEventListener("keydown", (event) => {
                keysPressed[event.key] = true;
            });
            document.addEventListener("keyup", (event) => {
                keysPressed[event.key] = false;
            });
            const move = () => {
                if (keysPressed["ArrowUp"] || keysPressed["w"]) {
                    velocity.y -= acceleration;
                }
                if (keysPressed["ArrowDown"] || keysPressed["s"]) {
                    velocity.y += acceleration;
                }
                if (keysPressed["ArrowLeft"] || keysPressed["a"]) {
                    velocity.x -= acceleration;
                }
                if (keysPressed["ArrowRight"] || keysPressed["d"]) {
                    velocity.x += acceleration;
                }
                velocity.x *= deceleration;
                velocity.y *= deceleration;
                offsetX += velocity.x;
                offsetY += velocity.y;
                if (Math.abs(velocity.x) < 0.1) {
                    velocity.x = 0;
                }
                if (Math.abs(velocity.y) < 0.1) {
                    velocity.y = 0;
                }
                //drawGrid();
                requestAnimationFrame(move);
            };
            move();
        });
    </script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }
        .hidden {
            display: none;
        }
        .selected {
            border: 2px solid black;
        }
        #colours {
            position: fixed;
            bottom: 10px;
            left: 10px;
            display: flex;
            gap: 10px;
        }
        #colours div {
            width: 30px;
            height: 30px;
            cursor: pointer;
        }
        #red { background-color: red; }
        #green { background-color: green; }
        #blue { background-color: blue; }
        #yellow { background-color: yellow; }
        #purple { background-color: purple; }
        #cyan { background-color: cyan; }
        #white { background-color: white; }
        #black { background-color: black; }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    <div id="colours" class="hidden">
        <div id="red" onclick="selectColor('red')"></div>
        <div id="green" onclick="selectColor('green')"></div>
        <div id="blue" onclick="selectColor('blue')"></div>
        <div id="yellow" onclick="selectColor('yellow')"></div>
        <div id="purple" onclick="selectColor('purple')"></div>
        <div id="cyan" onclick="selectColor('cyan')"></div>
        <div id="white" onclick="selectColor('white')"></div>
        <div id="black" onclick="selectColor('black')"></div>
    </div>
    <audio src="ding.mp3" preload="auto"></audio>
    <script>
        function selectColor(color) {
            console.log("Color selected:", color);
            if (chosenColor) {
                document.getElementById(chosenColor).classList.remove("selected");
            }
            chosenColor = color;
            document.getElementById(color).classList.add("selected");
        }
    </script>
</body>
</html>
