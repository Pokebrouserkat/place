<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Place</title>
    <script>
        const ws = new WebSocket("/ws");
        const tileColors = {};
        var canvasSize = 50;
        var rateLimit = -1;
        ws.onmessage = (event) => {
            // Is it a number?
            if (!isNaN(event.data)) {
                if (rateLimit === -1) {
                    rateLimit = parseInt(event.data);
                    return;
                }
                canvasSize = parseInt(event.data);
                return;
            }
            const data = JSON.parse(event.data);
            tileColors[`${data.x},${data.y}`] = data.color;
            //drawGrid();
        };
        ws.onclose = () => {
            // THIS IS A TEMPORARY FIX
            location.reload();
        };
        // Authenticate the user
        ws.onopen = () => {
            ws.send(window.location.hash.substring(window.location.hash.indexOf("access_token=") + 13).split("&")[0].split("/")[0]);
        };
        window.location.hash = "";
        var canvas;
        var chosenColor = null;
        var ctx;
        const tileSize = 20;
        let zoom = 1;
        let offsetX = 0;
        let offsetY = 0;
        let selectedTile = null;
        const keysPressed = {};
        const velocity = { x: 0, y: 0 };
        const maxSpeed = 10;
        const acceleration = 0.4;
        const deceleration = 0.8;

        //function resizeCanvas() {
        const resizeCanvas = () => { // Bleh
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            //drawGrid();
        }

        function drawGrid() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const cols = Math.ceil(canvas.width / (tileSize * zoom)) + 2;
            const rows = Math.ceil(canvas.height / (tileSize * zoom)) + 2;
            const startX = Math.floor(offsetX) - Math.floor(cols / 2);
            const startY = Math.floor(offsetY) - Math.floor(rows / 2);
            ctx.fillStyle = "#000000";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            var tileSizeTimesZoom = tileSize * zoom;
            var tileSizeTimesZoomMinusOne = (tileSize - 1) * zoom;
            var floorColsDiv2 = cols >> 1;
            var floorRowsDiv2 = rows >> 1;
            for (let x = startX; x < startX + cols; x++) {
                for (let y = startY; y < startY + rows; y++) {
                    const color = tileColors[`${x},${y}`] || (((Math.abs(x) < canvasSize) && (Math.abs(y) < canvasSize)) ? "#ffffff" : "#000000");
                    ctx.fillStyle = color;
                    const drawX = (x - offsetX + floorColsDiv2) * tileSizeTimesZoom;
                    const drawY = (y - offsetY + floorRowsDiv2) * tileSizeTimesZoom;
                    ctx.fillRect(drawX, drawY, tileSizeTimesZoomMinusOne, tileSizeTimesZoomMinusOne);
                }
            }
        }

        var canPlace = false;

        function handleTileClick(x, y, mouseX, mouseY) {
            if (chosenColor) {
                const confirmChange = confirm("Change the tile colour?");
                if (confirmChange) {
                    ws.send(JSON.stringify({ x: x - 1, y: y - 2, color: chosenColor }));
                    // This is where the timer comes in
                    canPlace = false;
                    //document.getElementById("colours").classList.add("hidden");
                    document.getElementById("red").classList.remove("selected");
                    document.getElementById("green").classList.remove("selected");
                    document.getElementById("blue").classList.remove("selected");
                    document.getElementById("yellow").classList.remove("selected");
                    document.getElementById("purple").classList.remove("selected");
                    document.getElementById("cyan").classList.remove("selected");
                    document.getElementById("white").classList.remove("selected");
                    document.getElementById("black").classList.remove("selected");
                    document.getElementById("red").classList.add("hidden");
                    setTimeout(function() {
                        document.getElementById("green").classList.add("hidden");
                        setTimeout(function() {
                            document.getElementById("blue").classList.add("hidden");
                            setTimeout(function() {
                                document.getElementById("yellow").classList.add("hidden");
                                setTimeout(function() {
                                    document.getElementById("purple").classList.add("hidden");
                                    setTimeout(function() {
                                        document.getElementById("cyan").classList.add("hidden");
                                        setTimeout(function() {
                                            document.getElementById("white").classList.add("hidden");
                                            setTimeout(function() {
                                                document.getElementById("black").classList.add("hidden");
                                                if (rateLimit > 1) {
                                                    setTimeout(function() {
                                                        document.getElementById("colours").classList.add("hidden");
                                                        setTimeout(function() {
                                                            document.getElementById("red").classList.remove("hidden");
                                                            document.getElementById("green").classList.remove("hidden");
                                                            document.getElementById("blue").classList.remove("hidden");
                                                            document.getElementById("yellow").classList.remove("hidden");
                                                            document.getElementById("purple").classList.remove("hidden");
                                                            document.getElementById("cyan").classList.remove("hidden");
                                                            document.getElementById("white").classList.remove("hidden");
                                                            document.getElementById("black").classList.remove("hidden");
                                                        }, 100);
                                                    }, 100);
                                                }
                                            }, 100);
                                        }, 100);
                                    }, 100);
                                }, 100);
                            }, 100);
                        }, 100);
                    }, 100);

                    setTimeout(function() {
                        canPlace = true;
                        document.getElementById("colours").classList.remove("hidden");
                        document.getElementsByTagName("audio")[0].play();
                    }, rateLimit * 1000);
                    //drawGrid();
                }
            }
        }

        document.addEventListener("keydown", (e) => {
            keysPressed[e.key] = true;
        });

        document.addEventListener("keyup", (e) => {
            keysPressed[e.key] = false;
        });

        function updateOffset() {
            if (keysPressed["ArrowUp"] && !keysPressed["ArrowDown"]) {
                velocity.y = Math.max(velocity.y - acceleration, -maxSpeed);
            } else if (keysPressed["ArrowDown"] && !keysPressed["ArrowUp"]) {
                velocity.y = Math.min(velocity.y + acceleration, maxSpeed);
            } else {
                velocity.y = Math.abs(velocity.y) < deceleration ? 0 : velocity.y + (velocity.y > 0 ? -deceleration : deceleration);
            }

            if (keysPressed["ArrowLeft"] && !keysPressed["ArrowRight"]) {
                velocity.x = Math.max(velocity.x - acceleration, -maxSpeed);
            } else if (keysPressed["ArrowRight"] && !keysPressed["ArrowLeft"]) {
                velocity.x = Math.min(velocity.x + acceleration, maxSpeed);
            } else {
                velocity.x = Math.abs(velocity.x) < deceleration ? 0 : velocity.x + (velocity.x > 0 ? -deceleration : deceleration);
            }

            offsetX += velocity.x / (tileSize * zoom);
            offsetY += velocity.y / (tileSize * zoom);
        }

        function animate() {
            updateOffset();
            drawGrid();
            requestAnimationFrame(animate);
            window.location.hash = (offsetX || offsetY || zoom) ? `#x=${offsetX}&y=${offsetY}&zoom=${zoom}` : "";
        }

        window.addEventListener("wheel", (e) => {
            e.preventDefault();
            const zoomFactor = 1.1;
            if (e.deltaY > 0) {
                zoom /= zoomFactor;
            } else {
                zoom *= zoomFactor;
            }
            zoom = Math.max(0.2, Math.min(zoom, 20)); // If you zoom out too much, it lags really badly
            //drawGrid();
        });

        window.addEventListener("resize", resizeCanvas);

        // Prevent default scrolling behavior
        window.addEventListener("keydown", (e) => {
            if (["ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight"].includes(e.key)) {
                e.preventDefault();
            }
        });
        function selectColour(button) {
            const buttons = document.querySelectorAll("button");
            buttons.forEach((button) => {
                button.classList.remove("selected");
            });
            button.classList.add("selected");
            switch (button.id) {
                case "red":
                    chosenColor = "#ff0000";
                    break;
                case "green":
                    chosenColor = "#00ff00";
                    break;
                case "blue":
                    chosenColor = "#0000ff";
                    break;
                case "yellow":
                    chosenColor = "#ffff00";
                    break;
                case "purple":
                    chosenColor = "#ff00ff";
                    break;
                case "cyan":
                    chosenColor = "#00ffff";
                    break;
                case "white":
                    chosenColor = "#ffffff";
                    break;
                case "black":
                    chosenColor = "#000000";
                    break;
            }
        }
        document.addEventListener("DOMContentLoaded", () => {
            canvas = document.getElementById("canvas");
            ctx = canvas.getContext("2d");
            canvas.addEventListener("click", (e) => {
                const rect = canvas.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;
                const x = Math.floor((mouseX / (tileSize * zoom)) + offsetX - Math.floor(canvas.width / (tileSize * zoom) / 2));
                const y = Math.floor((mouseY / (tileSize * zoom)) + offsetY - Math.floor(canvas.height / (tileSize * zoom) / 2));
                handleTileClick(x, y, e.clientX, e.clientY);
            });
            resizeCanvas();
            animate();
        });
    </script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000000;
        }
        #colours {
            position: absolute;
            display: none;
        }
        canvas {
            display: block;
        }
        #red {
            background-color: #ff0000;
            border: 0.5vh solid #aa0000;
        }
        #green {
            background-color: #00ff00;
            border: 0.5vh solid #00aa00;
        }
        #blue {
            background-color: #0000ff;
            border: 0.5vh solid #0000aa;
        }
        #yellow {
            background-color: #ffff00;
            border: 0.5vh solid #aaaa00;
        }
        #purple {
            background-color: #ff00ff;
            border: 0.5vh solid #aa00aa;
        }
        #cyan {
            background-color: #00ffff;
            border: 0.5vh solid #00aaaa;
        }
        #white {
            background-color: #ffffff;
            border: 0.5vh solid #aaaaaa;
        }
        #black {
            background-color: #000000;
            border: 0.5vh solid #333333;
        }
        button:hover {
            transform: scale(1.1);
        }
        #red:active {
            box-shadow: 0 0 1vh 1vh #aa0000;
        }
        #green:active {
            box-shadow: 0 0 1vh 1vh #00aa00;
        }
        #blue:active {
            box-shadow: 0 0 1vh 1vh #0000aa;
        }
        #yellow:active {
            box-shadow: 0 0 1vh 1vh #aaaa00;
        }
        #purple:active {
            box-shadow: 0 0 1vh 1vh #aa00aa;
        }
        #cyan:active {
            box-shadow: 0 0 1vh 1vh #00aaaa;
        }
        #white:active {
            box-shadow: 0 0 1vh 1vh #aaaaaa;
        }
        #black:active {
            box-shadow: 0 0 1vh 1vh #333333;
        }
        #red.selected {
            box-shadow: 0 0 0.5vh 0.5vh #aa0000;
        }
        #green.selected {
            box-shadow: 0 0 0.5vh 0.5vh #00aa00;
        }
        #blue.selected {
            box-shadow: 0 0 0.5vh 0.5vh #0000aa;
        }
        #yellow.selected {
            box-shadow: 0 0 0.5vh 0.5vh #aaaa00;
        }
        #purple.selected {
            box-shadow: 0 0 0.5vh 0.5vh #aa00aa;
        }
        #cyan.selected {
            box-shadow: 0 0 0.5vh 0.5vh #00aaaa;
        }
        #white.selected {
            box-shadow: 0 0 0.5vh 0.5vh #aaaaaa;
        }
        #black.selected {
            box-shadow: 0 0 0.5vh 0.5vh #333333;
        }
        #red, #green, #blue, #yellow, #purple, #cyan, #white, #black {
            transition: all 0.5s;
            width: 5vh;
            height: 5vh;
            margin: 0.5vh;
            border-radius: 0;
            cursor: pointer;
        }
        #colours {
            display: flex;
            flex-wrap: wrap;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
            transition: all 1s;
        }
        .hidden {
            filter: blur(1vh);
            opacity: 0;
            transition: all 1s;
        }
    </style>
</head>
<body>
    <div id="colours">
        <button onclick="selectColour(this)" id="red"></button>
        <button onclick="selectColour(this)" id="green"></button>
        <button onclick="selectColour(this)" id="blue"></button>
        <button onclick="selectColour(this)" id="yellow"></button>
        <button onclick="selectColour(this)" id="purple"></button>
        <button onclick="selectColour(this)" id="cyan"></button>
        <button onclick="selectColour(this)" id="white"></button>
        <button onclick="selectColour(this)" id="black"></button>
    </div>
    <!-- TODO: Add a timer to show the remaining time -->
    <canvas id="canvas"></canvas>
    <audio src="/boop" preload="auto" style="display: none;" />
</body>
</html>
